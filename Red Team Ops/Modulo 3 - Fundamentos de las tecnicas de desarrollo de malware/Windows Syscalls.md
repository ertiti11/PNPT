## Entendiendo los Syscalls en Windows

En los sistemas operativos Windows, una **llamada al sistema (syscall)** es el mecanismo que permite a las aplicaciones en **modo usuario** solicitar servicios al **kernel**.  
Este paso de _user mode_ a _kernel mode_ es esencial para operaciones como:

- Acceso a archivos.
    
- Gesti√≥n de memoria.
    
- Control de procesos.
    

Normalmente, las aplicaciones usan APIs de alto nivel de librer√≠as como **kernel32.dll**. Estas APIs llaman a su vez a las **APIs nativas** en **ntdll.dll** (ej. _NtAllocateVirtualMemory_).  
Las APIs nativas contienen un **stub de syscall**, que incluye la instrucci√≥n `syscall` que transfiere la ejecuci√≥n al kernel.

Cada syscall se identifica por un **System Service Number (SSN)** √∫nico, que se carga en el registro **EAX** antes de ejecutar la instrucci√≥n `syscall`. El kernel utiliza ese n√∫mero para decidir qu√© servicio ejecutar.

---

## Direct Syscalls

### ¬øQu√© son?

Los **direct syscalls** consisten en **invocar la instrucci√≥n syscall directamente** desde c√≥digo propio, en lugar de llamar a una funci√≥n en _ntdll.dll_.  
El programa implementa su propio _stub_ de syscall con el SSN correcto.

### ¬øPor qu√© usarlos?

Los sistemas EDR suelen **enganchar (hookear)** APIs en modo usuario para monitorizar llamadas.  
Con _direct syscalls_, el c√≥digo no depende de esas APIs enganchadas, por lo que puede **evadir los hooks de EDR**.

### Implementaci√≥n

Un _direct syscall_ implica:

1. Mover el SSN al registro **EAX**.
    
2. Configurar los registros adecuados (**RCX, RDX, etc.**) con los par√°metros de la syscall.
    
3. Ejecutar la instrucci√≥n `syscall`.
    

‚ö†Ô∏è Problema: los SSN cambian entre versiones de Windows.  
Soluciones como **Hell‚Äôs Gate** o **Halo‚Äôs Gate** permiten obtener din√°micamente los SSN en tiempo de ejecuci√≥n, mejorando compatibilidad y sigilo.

### Limitaciones

- La instrucci√≥n `syscall` se ejecuta fuera de _ntdll.dll_, lo cual es un comportamiento at√≠pico.
    
- La direcci√≥n de retorno despu√©s de la syscall apunta a memoria no est√°ndar.
    

üëâ Esto puede ser detectado por EDR avanzados que busquen anomal√≠as.

---

## Indirect Syscalls

### ¬øQu√© son?

Los **indirect syscalls** buscan el beneficio de los directos pero imitando un comportamiento m√°s leg√≠timo.  
En vez de ejecutar directamente `syscall`, el programa **salta a la instrucci√≥n syscall dentro de ntdll.dll**.

### ¬øPor qu√© usarlos?

- Evitan hooks en modo usuario al no invocar la API completa.
    
- Mantienen una _call stack_ m√°s leg√≠tima, reduciendo el riesgo de detecci√≥n.
    

### Implementaci√≥n

Un _indirect syscall_ implica:

1. Localizar la direcci√≥n de la funci√≥n deseada en _ntdll.dll_.
    
2. Calcular el offset hasta la instrucci√≥n `syscall` dentro de esa funci√≥n.
    
3. Preparar los registros con los par√°metros de la syscall.
    
4. Saltar a la instrucci√≥n `syscall` dentro de _ntdll.dll_.
    

Esto hace que tanto la ejecuci√≥n como el retorno ocurran dentro de _ntdll.dll_, lo que se ajusta al comportamiento esperado.

### Limitaciones

Aunque son m√°s sigilosos que los directos, todav√≠a pueden ser detectados por:

- EDRs que analicen la pila de llamadas completa.
    
- Monitorizaci√≥n de patrones de control de flujo an√≥malos.
    

---

## Comparaci√≥n: Direct vs Indirect Syscalls

|Caracter√≠stica|Direct Syscall|Indirect Syscall|
|---|---|---|
|Usa `syscall` crudo|S√≠|No|
|Evita APIs hookeadas|S√≠|S√≠|
|Requiere ID de syscall (SSN)|S√≠|No siempre|
|Seguro entre versiones Win|No|S√≠|
|Nivel de sigilo|Alto|Alto|
|Complejidad|Alta (assembly)|Media (l√≥gica de parsing)|

---

## Consideraciones frente a EDR

- **Direct syscalls** ‚Üí evaden hooks en modo usuario, pero pueden ser detectados por patrones de ejecuci√≥n at√≠picos.
    
- **Indirect syscalls** ‚Üí imitan mejor el comportamiento esperado, pero pueden ser detectados si se analiza la pila de llamadas o desde kernel mode.
    

üëâ Esto refleja la eterna din√°mica **gato y rat√≥n** entre atacantes y defensores en ciberseguridad.

---

## Herramientas y Referencias

- **Hell‚Äôs Gate** ‚Üí resoluci√≥n din√°mica de SSNs. [GitHub](https://github.com/am0nsec/HellsGate?utm_source=chatgpt.com)
    
- **Halo‚Äôs Gate** ‚Üí variante m√°s sigilosa. [GitHub](https://github.com/Am0nsec/Halo-s-Gate?utm_source=chatgpt.com)
    
- **SysWhispers 2** ‚Üí genera headers y stubs para direct syscalls. [GitHub](https://github.com/jthuraisamy/SysWhispers2?utm_source=chatgpt.com)
    
- **SysWhispers 3** ‚Üí a√±ade t√©cnicas de ofuscaci√≥n. [GitHub](https://github.com/klezVirus/SysWhispers3?utm_source=chatgpt.com)
    
- **InlineSyscall** ‚Üí ejemplo pr√°ctico con shellcode inline. [GitHub](https://github.com/nbs32k/inline-syscall?utm_source=chatgpt.com)